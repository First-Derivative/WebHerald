{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ article.title }}{% endblock title%}

{% block content %}

<div class="row border my-3 p-3" id="article_container">

  <!-- Column 1 - Article body -->
  <div class="col-9 px-3 py-2 w-auto">
    <div class ="article_heading_wrapper article_heading">
      <div class="article_heading_container">
        <h2 class="serifText">{% block headline %}{{ article.title }}{% endblock %}</h2>
        <h5>{% block sub %}{{ article.sub_title }}{% endblock %}</h5>
      </div>
    </div>

    <!-- a litle white space -->
    <br>

    <div class="article_image_wrapper pt-3">
      <div class="article_image_container">
        <img src="{% static article.get_imageurl %}" class="img-fluid" alt="{{ article.image_caption }}">
        <figcaption class="figure-caption">{% block caption %}{{ article.image_caption }}{% endblock %}</figcaption>
      </div>
    </div>

    <!-- a litle white space -->
    <br>

    <div class="article_text py-3">
      {% block text %}{{ article.content|safe }}{% endblock %}
    </div>
  </div>

  <!-- Column 2 - Category Heading,  Meta -->
  <div class="col-3 px-0 py-2">

    <div class="article_meta flex-column">
      <h4><strong>Authored by:</strong></h4>
      <h4><span style="font-style:italic">{{ article.author }}</span></h4>

      <p style="padding-bottom:0px;padding-top:1rem;"><strong>Category:</strong></p>
      <p><span style="font-style:italic">{% if selected_category %}{{ selected_category }}{% endif %}</span></p>
      <p>{% block dop %}{{ article.dop }}{% endblock %}</p>

      {% if user.is_authenticated %}
      <button type="button" class="btn btn-outline-dark like-button" id="{{ article.id }}">
        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-heart-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/>
        </svg>
        <span class="display_numlikes">{% block likes %}{{ article.like_count }}{% endblock %}</span>
      </button>
      {% else %}
        <p>{{article.like_count}} Likes</p>
      {% endif %}

    </div>

</div>
  </div>


  <!-- Comments -->
<div class="row border my-3 p-3 w-auto" id="comments_section">

  <div class="col-9 p-2 width-auto">
      <h2>Comments</h2>

    <!-- Comment post form -->
    <div class="post_comment py-3">
      <form>
        <div class="form-group">
          <textarea name="comment" class="form-control" rows="3" placeholder="Join the conversation..."></textarea>
        </div>
        <button type="submit" class="btn btn-dark">Post your comment</button>
      </form>
  </div>

    <hr>

    <!-- Display comments -->
    <div class="media">
      <img src="{% static 'images/profile_pictures/empty-profile.jpg' %}" class="mr-3" alt="..." width="64px" height="64px">
      <div class="media-body">
        <h5 class="mt-0">Insert Username</h5>
        This is an example of a parent comment. Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi vulputate fringilla. Donec lacinia congue felis in faucibus.
        <h6><br>Reply</h6>
        <hr>
        <div class="media mt-3">
          <a class="mr-3" href="#">
            <img src="{% static 'images/profile_pictures/empty-profile.jpg' %}" class="mr-3" alt="..." width="64px" height="64px">
          </a>
          <div class="media-body">
            <h5 class="mt-0">Insert Username</h5>
            This is an example of a reply. Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin. Cras purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi vulputate fringilla. Donec lacinia congue felis in faucibus.
            <h6><br>Reply</h6>
            <hr>
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

{% endblock content %}

{% block scripts %}
<script>
  $('#nav_EN').addClass('active')

  var article_id
  var user_liked = false
  var token = '{{csrf_token}}';
  var user_auth = '{{user.is_authenticated}}'

  if (user_auth == 'True') { // only handle likes if user is logged in

    $(function() {
      article_id = $('.like-button').attr('id')
      console.log(user_auth)
        // check whether user has liked this article before
        $.ajax({
          type: 'GET',
          headers: { "X-CSRFToken": token },
          url: "{% url 'likes' 0 %}".replace("0", article_id),
          dataType: 'json',
          success: function (response) {
              // set appearance of like button if already liked
              if (response.is_liked == 'true') {
                console.log('already liked')
                user_liked = true
                $('.btn-outline-dark').css({'color': 'red', 'border-color': 'red'})
              }
          },
          error: function(textStatus, errorThrown) {
              alert("Ajax request failed: " + textStatus + ' ' + errorThrown)
          }
        })
      })

    $(".like-button").click(function() {
      article_id = $(this).attr('id')
        if (user_liked == true) {
          // remove like
          $.ajax({
            type: 'DELETE',
            headers: { "X-CSRFToken": token },
            url: "{% url 'likes' 0 %}".replace("0", article_id),
            dataType: 'json',
            success: function (response) {
              $('.display_numlikes').html(response.num_likes) // update like like_count
              $('.like-button').css({'color': '#343a40', 'border-color': '#343a40'})
              user_liked = false
            },
            error: function(textStatus, errorThrown) {
                alert("Ajax request failed: " + textStatus + ' ' + errorThrown)
            }
          })
        }
        if (user_liked == false) {
          // register like
          $.ajax({
            type: 'POST',
            headers: { "X-CSRFToken": token },
            url: "{% url 'likes' 0 %}".replace("0", article_id),
            dataType: 'json',
            success: function (response) {
                $('.display_numlikes').html(response.num_likes) // update like like_count
                $('.like-button').css({'color': 'red', 'border-color': 'red'})
                user_liked = true
            },
            error: function(textStatus, errorThrown) {
                alert("Ajax request failed: " + textStatus + ' ' + errorThrown)
            }
          })
        }

    })
  }
</script>
{% endblock %}
